apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
  namespace: {{ .Release.Namespace }}
data:
  tiers.toml: |
    {{- range $tier := .Values.proxyConfig.tiers }}
    [[tiers]]
    name = "{{ $tier.name }}"
    {{- if $tier.maxConnections }}
    max_connections = {{ $tier.maxConnections }}
    {{- end }}
    {{- if $tier.rates }}
    {{- range $rate := $tier.rates }}
    [[tiers.rates]]
    interval = "{{ $rate.interval }}"
    limit = {{ div $rate.limitPerReplica $.Values.proxy.replicas }}
    {{- end }}
    {{- end }}
    {{- end }}
